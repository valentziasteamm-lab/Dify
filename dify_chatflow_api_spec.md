# Dify チャットフロー API 連携 調査仕様書

**作成日**: 2026-02-18  
**目的**: Difyチャットフローの出力再現性テストを自動化するための技術調査

---

## 1. 背景と目的

チャットフローの開発・デバッグにおいて、同一入力に対する出力の再現性を繰り返し検証する必要がある。Difyプレビュー画面での手動テスト（コピペによる入力）は実施済みだが、回数増加に伴い手作業の限界に達した。これを自動化する手段を調査する。

---

## 2. Dify チャットフロー API 仕様

### 2.1 エンドポイント

| 項目 | 値 |
|---|---|
| メソッド | `POST` |
| パス | `/v1/chat-messages` |
| Content-Type | `application/json` |
| 認証 | `Authorization: Bearer {API_KEY}` |

### 2.2 必要な情報（3点）

| 項目 | 説明 | 取得方法 |
|---|---|---|
| Base URL | DifyインスタンスのAPIエンドポイント | クラウド版: `https://api.dify.ai/v1`、セルフホスト版: `http://<host>/v1` |
| API Key | アプリ固有の認証キー（`app-xxxx` 形式） | Dify管理画面 → 対象アプリ →「概要」or「APIアクセス」→「APIキー」で生成 |
| User ID | 任意のユーザー識別子 | 呼び出し側で自由に設定（例: `"user-001"`） |

**注意**: API Keyはチャットフローごとに固有。別アプリのキーは使用不可。

### 2.3 リクエストボディ

| パラメータ | 型 | 必須 | 説明 |
|---|---|---|---|
| `query` | string | ✅ | ユーザーの入力メッセージ |
| `user` | string | ✅ | ユーザー識別子 |
| `inputs` | object | — | チャットフローStartノードで定義した変数のkey/value |
| `response_mode` | string | — | `"blocking"`（同期）or `"streaming"`（SSE）。デフォルト: streaming |
| `conversation_id` | string | — | 会話継続時に指定 |
| `files` | array | — | 画像等のファイル添付（Vision対応モデル用） |
| `auto_generate_name` | boolean | — | 会話タイトルの自動生成。デフォルト: true |

**制約**: blockingモードのCloudflareタイムアウトは100秒。

### 2.4 レスポンス形式（参考 — blockingモード）

以下はAPIから返却されるJSONの構造例。実行するものではなく、2.5のPythonコードを実行した際の戻り値がこの形式となる。

```json
{
  "event": "message",
  "task_id": "uuid",
  "message_id": "uuid",
  "conversation_id": "uuid",
  "mode": "chat",
  "answer": "応答テキスト",
  "metadata": {
    "usage": {
      "prompt_tokens": 123,
      "completion_tokens": 456,
      "total_tokens": 579
    }
  },
  "created_at": 1234567890
}
```

### 2.5 Python 最小実装例

```python
import requests

DIFY_BASE_URL = "http://<host>/v1"
DIFY_API_KEY = "app-xxxxxxxxxxxxxxxx"

def chat(query: str, user: str = "user-001", conversation_id: str = "") -> dict:
    resp = requests.post(
        f"{DIFY_BASE_URL}/chat-messages",
        headers={
            "Authorization": f"Bearer {DIFY_API_KEY}",
            "Content-Type": "application/json",
        },
        json={
            "query": query,
            "user": user,
            "inputs": {},
            "response_mode": "blocking",
            "conversation_id": conversation_id,
        },
    )
    resp.raise_for_status()
    return resp.json()
```

---

## 3. 環境制約：ネットワーク問題

### 3.1 現状

| 項目 | 状況 |
|---|---|
| Difyの運用形態 | 親会社によるセルフホスト（プライベートIP: `10.x.x.x`） |
| 自身のネットワーク | 子会社（親会社とは別ネットワーク） |
| DifyのWeb UI | ブラウザからアクセス可能（前提） |
| Dify API（`/v1/chat-messages`） | **未確認** — プライベートIPへの到達可否がボトルネック |

### 3.2 接続パターンと可能性

| パターン | 説明 | 確認先 |
|---|---|---|
| 拠点間VPN / 専用線 | 親子会社間でネットワーク接続済みなら到達可能 | 自社 情シス |
| クライアントVPN | 親会社ネットワークへのVPNアカウント発行 | 親会社 管理者 |
| リバースプロキシ | Difyが外部公開されている可能性（低） | Dify管理者 |

### 3.3 疎通確認コマンド（PowerShell）

```powershell
try {
    $response = Invoke-WebRequest -Uri "http://10.60.xxx.xxx/v1/parameters" `
        -Headers @{ "Authorization" = "Bearer app-your-key" } `
        -Method Get -TimeoutSec 10 -UseBasicParsing
    Write-Host "Status: $($response.StatusCode) → ネットワーク到達可（API利用可能）"
} catch {
    $code = $_.Exception.Response.StatusCode.value__
    if ($code) {
        Write-Host "Status: $code → ネットワーク到達可（認証エラー等、API Key要確認）"
    } else {
        Write-Host "接続失敗: $($_.Exception.Message) → 経路なし（管理者へ依頼が必要）"
    }
}
```

| 結果 | 判定 |
|---|---|
| Status: 200 | ネットワーク到達可、API利用可能 |
| Status: 401 / 403 | ネットワーク到達可、API Key等の認証設定を確認 |
| 接続失敗（タイムアウト等） | 経路なし、管理者へ依頼が必要 |

---

## 4. 実行手順

以下の順序で進めること。各ステップの結果により次のアクションが分岐する。

### Step 1: API Keyの取得

**実行者**: 自分（Dify管理画面にEditor以上の権限がある場合）または親会社のDify管理者

1. Dify管理画面にログイン
2. 対象チャットフローを開く
3. 「概要」または「APIアクセス」タブを選択
4. 「APIキー」をクリックし、新しいキーを生成
5. 表示されたキー（`app-xxxx` 形式）を安全な場所に保存

**権限がない場合**: → Step 4 で親会社管理者にAPI Keyの発行も併せて依頼する。

### Step 2: ネットワーク疎通確認（PowerShell）

**実行場所**: ハイペリオン（会社PC）のPowerShell

セクション3.3のPowerShellコマンドを、Step 1で取得したAPI Keyと実際のBase URLに書き換えて実行する。

| 結果 | 次のアクション |
|---|---|
| Status: 200 | → **Step 3 へ進む**（API利用可能） |
| Status: 401 / 403 | → ネットワークは到達可。API Keyまたはアプリの公開状態を確認 |
| 接続失敗（タイムアウト等） | → **Step 4 へ進む**（管理者への依頼が必要） |

### Step 3: Python による再現性テスト実行

**実行場所**: ハイペリオン（会社PC）

1. セクション2.5のPythonコードを `DIFY_BASE_URL` と `DIFY_API_KEY` を実際の値に書き換えて保存
2. テスト対象のクエリを設定して実行
3. レスポンス（セクション2.4の形式）の `answer` フィールドを記録し、再現性を比較

**ここで完了。** Step 4 は Step 2 で接続失敗した場合のみ実行する。

### Step 4: 親会社管理者への依頼（接続失敗時のみ）

Step 2 で接続できなかった場合、セクション5の依頼内容に従い親会社管理者へ連絡する。

---

## 5. 親会社管理者への依頼内容

### 5.1 依頼の背景（管理者に伝える内容）

親会社が運用するDifyサーバー（プライベートIP: `10.x.x.x`）に対し、子会社ネットワークからAPI経由でアクセスしたい。目的はチャットフロー開発におけるデバッグの自動化であり、Web UIでの手動テストでは効率に限界がある。

### 5.2 依頼事項の一覧

管理者に依頼・確認すべき内容は以下の通り。状況に応じて必要な項目が変わる。

| # | 依頼事項 | 詳細 | 必要になる条件 |
|---|---|---|---|
| 1 | **ネットワーク経路の開通** | 子会社ネットワークからDifyサーバーの `POST /v1/chat-messages` エンドポイントへの通信許可 | Step 2で接続失敗した場合（必須） |
| 2 | **接続方式の指定** | VPN接続情報の提供、ファイアウォールルールの追加、またはリバースプロキシURLの共有のいずれか | #1と併せて |
| 3 | **API Keyの発行** | 対象チャットフローのAPI Keyを生成して共有 | 自分にDify管理画面のEditor権限がない場合 |
| 4 | **アプリの公開状態の確認** | 対象チャットフローが「Published（公開）」状態であることの確認 | API Keyはあるが401/403エラーが出る場合 |
| 5 | **APIアクセスの有効化** | モニタリング → Backend Service API設定でAPIアクセスが有効であることの確認 | #4と同様 |

### 5.3 管理者側で必要な作業の想定

依頼を受けた管理者が実施する作業は、接続方式によって異なる。

**パターンA: ファイアウォールルール追加（最も簡易）**

子会社のグローバルIPまたはネットワークレンジから、Difyサーバーの対象ポート（通常80 or 443）への通信を許可するルールを追加する。管理者側の作業量は最小。

**パターンB: VPNアカウント発行**

既に拠点間VPNが存在する場合はルーティング追加のみ。存在しない場合はVPNアカウントの新規発行が必要で、管理者側の作業量はやや大きい。

**パターンC: リバースプロキシの設置**

Dify APIをNginx等のリバースプロキシ経由で外部公開する。IP制限やBASIC認証等の追加セキュリティが必要となり、管理者側の作業量は最大。

### 5.4 依頼メッセージ（テンプレート）

以下をメール・チャット等で送付する。

> **件名**: 【依頼】子会社ネットワークからDify APIへのアクセス経路開通について
>
> お疲れ様です。チャットフローの開発を担当しております。
>
> 現在、チャットフローのデバッグにおいて同一入力に対する出力の再現性を繰り返しテストする必要があり、手動でのテストに限界を感じております。PythonスクリプトからDify APIを直接呼び出して自動テストを行いたいのですが、子会社ネットワークからDifyサーバー（`10.x.x.x`）への通信がタイムアウトとなり、接続できない状況です。
>
> つきまして、以下をご検討いただけないでしょうか。
>
> 1. 子会社ネットワークからDifyサーバーへのAPI通信経路の開通（対象: `POST /v1/chat-messages`）
> 2. 接続方式のご指定（VPN / ファイアウォール許可 / その他）
> 3. （権限不足の場合）対象チャットフローのAPI Key発行
>
> 利用はデバッグ目的のみで、大量リクエストを送る想定はありません。ご不明な点がございましたらお知らせください。よろしくお願いいたします。

### 5.5 依頼時の注意点

- 「なぜAPIが必要か」を具体的に伝える（手動テストの限界 → 自動化の必要性）
- 対象エンドポイントを明示し、全ポート開放ではないことを示す（セキュリティ上の懸念を軽減）
- 大量アクセスではない旨を伝える（サーバー負荷の懸念を軽減）

---

## 6. 対応方針

### 6.1 方針の選択肢

| # | 方式 | 前提条件 | 即時性 | 長期運用 |
|---|---|---|---|---|
| A | **Dify API + Python** | ネットワーク経路の開通 | △（管理者依頼待ち） | ◎ |
| B | **Playwright UI自動化** | Web UIにアクセス可能 | ◎（即日着手可） | △（UI変更に弱い） |

### 6.2 推奨アクション

1. **即時**: Playwright によるプレビュー画面自動化で、テスト作業をまず開始
2. **並行**: セクション5に従い、管理者へ API 経路の開通を依頼
3. **経路開通後**: Python + API に移行し、本格的な自動テスト環境を構築

---

## 7. 補足情報

### 7.1 既存Pythonライブラリ

PyPIに `dify-api-python` パッケージが存在し、streaming/blocking両対応。ただしrequests直接呼び出しで十分簡素なため、依存追加は任意。

### 7.2 API Key に関する注意

- API Keyはチャットフローごとに個別生成
- 管理画面でEditor以上のロールがあれば自身で発行可能
- 機密情報として扱い、ソースコードへの直接埋め込みは非推奨（環境変数等で管理）
- アプリが「公開（Published）」状態でないとAPIは機能しない
